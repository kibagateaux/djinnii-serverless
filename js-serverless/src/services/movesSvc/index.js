Object.defineProperty(exports,"__esModule",{value:true});exports.getMovesStorylineData=undefined;var _moves=require('moves');var _moves2=_interopRequireDefault(_moves);var _awsSdk=require('aws-sdk');var _awsSdk2=_interopRequireDefault(_awsSdk);var _movesData=require('../../lib/movesData');var _helpers=require('../../lib/helpers');var _database=require('../../lib/database');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var getMovesStorylineData=exports.getMovesStorylineData=function getMovesStorylineData(event,context){var userId=event.pathParameters.userId;var queryParams={TableName:process.env.DYNAMODB_TOKENS_TABLE||"djinii-mobilehub-1897344653-Tokens",Key:{userId:"+13472418464"}};_database.DB.get(queryParams,function(error,results){if(error){console.log('moves storyline fetch user tokens failed',error);context.done(error);}else if(results.Item&&results.Item.moves){var _results$Item$moves=results.Item.moves,access_token=_results$Item$moves.access_token,refresh_token=_results$Item$moves.refresh_token;var moves=new _moves2.default({client_id:process.env.MOVES_API_KEY||"kdiz90L264WQ72Sc7OO0_0IUM4ZRrcB6",access_token:access_token,refresh_token:refresh_token});moves.get('/user/storyline/daily?pastDays=7&trackPoints=true').then(function(response){var normalizedData=(0,_movesData.normalizeStorylineData)(response.data);var newActivities=(0,_movesData.createActivitiesList)(normalizedData);var dailySummaries=(0,_movesData.createDailyLedger)(normalizedData);var actBlobs=(0,_helpers.blobify)(newActivities);var activitiesTable="djinii-mobilehub-1897344653-Activities";var writes=Promise.all(actBlobs.map(function(blob){return(0,_database.batchPut)(activitiesTable,blob,"+13472418464");}));writes.then(function(results){console.log('writes res',results);}).catch(function(error){console.log('write err',error);});context.done(null,{});}).catch(function(error){console.log('moves storyline fetch data failed',error);context.done(error);});}else{console.log('get moves tokens null',results);context.done(error);}});};