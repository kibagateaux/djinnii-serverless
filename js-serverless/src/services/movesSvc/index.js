Object.defineProperty(exports,"__esModule",{value:true});exports.getMovesStorylineData=undefined;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _moves=require('moves');var _moves2=_interopRequireDefault(_moves);var _awsSdk=require('aws-sdk');var _awsSdk2=_interopRequireDefault(_awsSdk);var _movesData=require('../../lib/movesData');var _helpers=require('../../lib/helpers');var _database=require('../../lib/database');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}var getMovesStorylineData=exports.getMovesStorylineData=function getMovesStorylineData(event,context){var userId=event.pathParameters.userId;var queryParams={TableName:process.env.DYNAMODB_TOKENS_TABLE||"djinii-mobilehub-1897344653-Tokens",Key:{userId:"+13472418464"}};_database.DB.get(queryParams,function(error,results){if(error){console.log('moves storyline fetch user tokens failed',error);context.done(error);}else if(results.Item&&results.Item.moves){var _results$Item$moves=results.Item.moves,access_token=_results$Item$moves.access_token,refresh_token=_results$Item$moves.refresh_token;var moves=new _moves2.default({client_id:process.env.MOVES_API_KEY||"kdiz90L264WQ72Sc7OO0_0IUM4ZRrcB6",access_token:access_token,refresh_token:refresh_token});moves.get('/user/storyline/daily?pastDays=7&trackPoints=true').then(function(response){var normalizedData=(0,_movesData.normalizeStorylineData)(response.data);var newData=["activities","stats","locations"].reduce(function(newData,key){return _extends({},newData,_defineProperty({},key,normalizedData.reduce(function(ledger,day){return _extends({},ledger,day[key]);})));},{});var dbTables={activities:"djinii-mobilehub-1897344653-Activities",locations:"djinii-mobilehub-1897344653-Locations",stats:"djinii-mobilehub-1897344653-stats"};var dbWrites=Object.keys(newData).map(function(resource){var data=newData[resource];var ledger=Object.keys(data).map(function(time){return data[time];});var blobs=(0,_helpers.blobify)(ledger);var table=dbTables[resource];return blobs[0][0].length>0?blobs.map(function(blob){return(0,_database.batchPut)(table,blob,"+13472418464");}):null;});context.done(null,{});}).catch(function(error){console.log('moves storyline fetch data failed',error);context.done(error);});}else{console.log('get moves tokens null',results);context.done(error);}});};